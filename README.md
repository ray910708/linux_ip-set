# SSH-IP-Adder

## 1. 專案概述

SSH-IP-Adder 是一款專為系統管理員和雲端環境使用者設計的工具，提供圖形化界面，可通過 SSH 遠程連接到 Linux 服務器，實現自動添加、管理副 IP 地址與網絡配置的功能。本應用程式使用 Python 和 PyQt5 構建，支援多種 Linux 發行版，並能處理不同的網絡配置系統。

### 1.1 核心功能

- **SSH 連接管理**：支持密碼和密鑰認證方式
- **IP 地址管理**：添加、刪除、檢查 IP 配置
- **DHCP 到靜態 IP 的轉換**：自動將 DHCP 配置轉換為靜態 IP
- **多分發版支持**：適配 Debian/Ubuntu、RedHat/CentOS 和基於 Netplan 的系統
- **網絡診斷工具集成**：包含 ping、traceroute、DNS 查詢等功能
- **批量 IP 操作**：支持高效率的批量 IP 地址添加功能

### 1.2 技術特點

- **模塊化架構**：採用嚴格的模塊化設計，核心功能與 GUI 邏輯分離
- **自適應發行版檢測**：自動識別目標系統類型並使用對應的網絡配置方法
- **批處理優化**：實現 SSH 命令批處理，顯著提高網絡操作效率
- **異常處理機制**：完善的異常處理架構，確保操作可靠性
- **跨平台支持**：支持 Windows、macOS 和 Linux 操作系統

## 2. 系統要求

### 2.1 主機端要求

- Python 3.6+
- PyQt5 5.12+
- Paramiko 2.7+

### 2.2 目標伺服器要求

- 任何基於 Linux 內核的系統，支持以下網絡配置系統：
  - Debian/Ubuntu 風格 (/etc/network/interfaces)
  - RedHat/CentOS 風格 (/etc/sysconfig/network-scripts)
  - Netplan (Ubuntu 17.10+)
  - NetworkManager (適用於各種發行版)
- SSH 服務開啟並允許遠程管理

## 3. 安裝指南

### 3.1 依賴安裝

```bash
pip install -r requirements.txt
```

### 3.2 直接執行

```bash
python main.py
```

### 3.3 打包為可執行檔案 (選擇性)

```bash
# 使用 PyInstaller 打包
pip install pyinstaller
pyinstaller --onefile --windowed main.py
```

## 4. 專案架構

### 4.1 模組結構

```
ssh_ip_adder/
│
├── __init__.py                  # 套件初始化
├── main.py                      # 程式入口
│
├── core/                        # 核心功能實現
│   ├── __init__.py              # 核心模組初始化
│   ├── ssh_client.py            # SSH 客戶端實現
│   ├── ip_manager.py            # IP 地址管理實現
│   ├── config_manager.py        # 配置管理
│   └── exceptions.py            # 異常定義
│
├── gui/                         # 圖形界面模組
│   ├── __init__.py              # GUI 模組初始化
│   ├── main_window.py           # 主窗口實現
│   └── dialogs.py               # 對話框實現
│
└── utils/                       # 工具類模組
    ├── __init__.py              # 工具模組初始化
    ├── network_utils.py         # 網絡工具函數
    └── validators.py            # 資料驗證函數
```

### 4.2 核心模組說明

1. **SSH 客戶端模組 (ssh_client.py)**
   - 管理 SSH 連接建立和會話維護
   - 支持密碼和密鑰認證
   - 提供遠程命令執行介面
   - 文件傳輸功能實現

2. **IP 管理模組 (ip_manager.py)**
   - 實現跨發行版 IP 地址添加/刪除功能
   - 高效批量處理 IP 地址操作
   - 自適應不同的網絡配置系統
   - 網絡接口狀態檢測與管理

3. **配置管理器 (config_manager.py)**
   - 管理應用程序設置和用戶偏好
   - 保存和加載連接歷史
   - 實現配置文件備份與還原

4. **工具模組**
   - 提供 IP 地址操作、驗證等通用功能
   - 網絡地址計算與轉換工具
   - 跨平台兼容性處理

## 5. 功能詳解

### 5.1 SSH 連接管理

- **認證方式**：支持密碼認證和密鑰檔案認證
- **連接歷史**：保存和快速載入最近使用的連接
- **連接狀態監控**：實時監控並顯示連接狀態
- **環境檢測**：自動檢測遠程系統環境與配置

### 5.2 網絡接口管理

- **接口檢測**：自動檢測可用網絡接口
- **接口詳情**：顯示網絡接口的詳細配置信息
- **接口狀態切換**：支持啟用/禁用網絡接口
- **接口配置備份**：配置修改前自動備份

### 5.3 IP 地址管理

- **添加單個 IP**：添加單個 IP 地址到指定接口
- **批量添加 IP**：高效批量添加多個連續 IP 地址
- **移除 IP**：從指定接口移除不需要的 IP 地址
- **IP 配置檢查**：驗證當前 IP 配置狀態

### 5.4 DHCP 到靜態 IP 轉換

- **配置分析**：智能分析當前 DHCP 配置
- **無縫轉換**：保留現有 IP 配置自動轉換為靜態 IP
- **DNS 設置**：可自定義或保留原有 DNS 配置
- **持久化配置**：確保重啟後配置仍然有效

### 5.5 網絡工具

- **連接診斷**：Ping 和 Traceroute 功能
- **DNS 查詢**：快速檢查域名解析
- **網絡服務管理**：控制網絡相關服務
- **防火牆管理**：簡化防火牆端口操作

## 6. 技術實現細節

### 6.1 跨發行版支持

應用程序實現了完善的操作系統檢測機制，使用多層檢測邏輯：

1. **系統識別**：通過分析 /etc/os-release 文件識別系統類型
2. **配置文件檢測**：檢查特定路徑確認網絡配置系統
3. **命令可用性檢測**：檢測 netplan、nmcli 等命令是否可用
4. **適配策略選擇**：根據檢測結果選擇最適合的配置方法

### 6.2 IP 地址配置優化

針對不同配置系統，實現了專門的配置生成邏輯：

1. **Debian/Ubuntu 系統**：
   - 接口別名索引智能分配
   - 自動處理 interfaces.d 目錄結構
   - interfaces 文件格式化生成

2. **RedHat/CentOS 系統**：
   - 適配舊式 ifcfg 文件和新式 NetworkManager
   - 自動處理 IPADDR{n}/PREFIX{n} 序列
   - CentOS 9+ 適配 nmconnection 格式

3. **Netplan 系統**：
   - YAML 結構精確生成與解析
   - 配置文件選擇智能優化
   - 自動清理重複和衝突配置

### 6.3 性能優化

1. **SSH 命令批處理**：
   - 實現命令批處理機制，減少 SSH 調用次數
   - 使用臨時 shell 腳本執行批量操作
   - 連接複用優化，提高命令執行效率

2. **緩存機制**：
   - 接口信息緩存，減少重複查詢
   - 網絡配置信息智能緩存
   - 自動過期機制確保數據及時性

3. **非阻塞操作**：
   - 使用多線程處理耗時操作
   - UI 和後台操作分離，確保界面響應性
   - 操作結果異步通知機制

### 6.4 異常處理

實現了分層的異常處理架構：

1. **基礎異常類**：BaseAppError
2. **模組特定異常**：
   - SSHConnectionError：SSH 連接相關異常
   - IPConfigError：IP 配置相關異常
   - ValidationError：數據驗證異常
   - ConfigError：配置文件處理異常
3. **錯誤代碼系統**：每類異常使用特定錯誤代碼範圍
4. **異常恢復機制**：關鍵操作具備回滾能力

## 7. 使用示例

### 7.1 連接到服務器並添加 IP

1. 啟動應用程序後，在「SSH連接」標籤頁填寫服務器信息
2. 點擊「連接」按鈕建立 SSH 連接
3. 連接成功後，切換到「IP配置」標籤頁
4. 在網卡下拉列表中選擇目標網絡接口
5. 在「添加副IP地址」區域輸入 IP 地址並選擇子網掩碼
6. 點擊「添加IP」按鈕完成操作

### 7.2 將 DHCP 配置轉換為靜態 IP

1. 在「IP配置」標籤頁的網卡狀態區域中選擇目標網卡
2. 如果網卡當前為 DHCP 配置，「轉換為靜態IP」按鈕將可用
3. 點擊「轉換為靜態IP」按鈕
4. 確認當前 IP 信息並進行轉換
5. 轉換完成後，網卡類型將顯示為「靜態IP」

### 7.3 批量添加 IP 地址

1. 在「IP配置」標籤頁的「批量添加IP」區域
2. 輸入起始 IP 地址和結束 IP 地址
3. 選擇子網掩碼
4. 點擊「批量添加」按鈕
5. 系統將自動將指定範圍內的 IP 地址添加到選定網卡

## 8. 常見問題

### 8.1 連接問題

- **問題**：無法連接到服務器
  **解決方案**：確認 SSH 服務器地址、端口是否正確；檢查防火牆設置；確認認證信息正確性

- **問題**：認證失敗
  **解決方案**：檢查用戶名密碼是否正確；對於密鑰認證，確保密鑰文件權限設置正確

### 8.2 IP 配置問題

- **問題**：IP 添加成功但無法訪問
  **解決方案**：檢查子網掩碼設置；確認防火牆規則；檢查路由表設置

- **問題**：DHCP 轉靜態 IP 後網絡斷開
  **解決方案**：確保轉換前記錄正確的網關和 DNS 設置；如果問題持續，可使用「網絡工具」檢查配置

### 8.3 系統兼容性問題

- **問題**：不支持的網絡配置系統
  **解決方案**：應用程序通常可以識別大多數主流配置系統；若不支持，可考慮使用命令行工具設置

- **問題**：無法自動識別網絡接口
  **解決方案**：點擊「刷新網卡列表」按鈕；如果仍無法識別，可手動輸入接口名稱

## 9. 開發與擴展

### 9.1 代碼貢獻

- 克隆存儲庫
- 創建功能分支
- 提交更改並發起合併請求

### 9.2 擴展指南

要添加對新的系統類型的支持，主要需修改 `ip_manager.py` 模組，具體步驟：

1. 擴展 `_detect_os_type()` 方法以識別新系統
2. 實現特定系統的 IP 配置方法 (例如 `_add_permanent_ip_newtype()`)
3. 實現特定系統的 DHCP 到靜態 IP 轉換方法
4. 更新批量處理相關函數

### 9.3 UI 自定義

GUI 元素定義在 `gui/main_window.py` 和 `gui/dialogs.py` 中，可通過以下方式自定義：

1. 修改界面布局和元素定義
2. 自定義樣式表
3. 添加新的對話框和功能頁面

## 10. 版權和許可

本項目採用 MIT 許可證，詳情請參閱 LICENSE 文件。

---

感謝使用 SSH-IP-Adder！此工具旨在簡化網絡管理工作，提高系統管理效率。我們歡迎您的反饋和貢獻。
